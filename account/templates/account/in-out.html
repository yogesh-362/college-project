{% extends 'account/base.html' %}
{% block main-content %}
{% load static %}


<h1 class="main_heading">Employee Request list</h1>
<div class="container-xxl">
    <div class="card">
       <div class="card-header border-0 pt-6 d-flex justify-content-between align-items-center bg-light box_header_main box_header_main11">
       {% if request.user.emp_role == "Admin" or request.user.emp_role == "HR" %}
        <form class="search-form d-flex align-items-center employeeLeave" action="http://127.0.0.1:8000/in-out/" method="get">

             <div class="input-group">
                 <label for="month" class="visually-hidden">Search</label>
                    <input type="text" data-kt-customer-table-filter="search" id="searchInput" value="" name="searchInput" class="form-control form-control-solid search-input" placeholder="Search Employee" fdprocessedid="3pql1a">
             </div>
             <div >
                 <button class="button_mian" type="submit" name="searchButton" id="searchButton" fdprocessedid="48081" onclick="searchInOut()">Search</button>
             </div>
    </form>
        {% endif %}

     <form action="http://127.0.0.1:8000/in-out/" class="d-flex align-items-center employeeLeave">

            <div class="label-container ml-1">
                <label for="month" class="visually-hidden">Search Month</label>
<!--                <input type="month" name="month" id="month" class="form-control form-control-solid me-2"-->
<!--                       placeholder="Search Employee date">-->
                <input type="month" name="month" id="month" class="form-control form-control-solid me-2"
                   placeholder="Search Employee date" style="margin-right:120px ; margin-left:1px" >
            </div>


            <select class="form-control me-2"  id="statustypesearch" name="statustypesearch"
                    aria-label="Select Leave type" style="height:39px;width:190px;border-radius:5px;">
                <option value="">Select type...</option>
                <option value="Accepted">Accepted</option>
                <option value="Rejected">Rejected</option>
                <option value="Pending">Pending</option>

            </select>
            <button  class="button_mian" type="button" name="submit" id="searchButton1" style="margin-left:2px;">Search</button>

        </form>

<!--    <div class="card-title">-->
<!--        <h3 class="page-title d-flex align-items-center flex-wrap me-20 mb-300 mb-lg-0" style="font-size:22px;">Employee Request list</h3>-->
<!--    </div>-->
    <div class="card-toolbar">
                <div class="menu menu-sub menu-sub-dropdown w-300px w-md-325px" data-kt-menu="true"
                     id="kt-toolbar-filter"></div>
                 <button type="button" class="button_mian" data-bs-toggle="modal" data-bs-target="#addModal" id="addRequestButton" fdprocessedid="hrjq6j"><a>Add Request</a></button>

    </div>
</div>

        <div class="new" id="salarysearch">
            <div class="card-body pt-3">
                <div id="kt_customers_table_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">
                    <div class="table-responsive">
                        <table class="table align-middle table-row-dashed fs-6 gy-5 dataTable no-footer table_main" id="kt_customers_table">
                            <thead>
                                <tr class="text-start text-gray-400 fw-bolder fs-7">
                                    <th class="min-w-125px sorting">Name</th>
                                    <th class="min-w-125px sorting">Date</th>
                                    <th class="min-w-125px sorting">Type</th>
                                    <th class="min-w-125px sorting">Reason</th>
                                    <th class="min-w-125px sorting">Approvel-Status</th>
                                    {% if request.user.emp_role == "Admin" or request.user.emp_role == "HR" %}
                                     <th class="text-end min-w-70px sorting_disabled">Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody class="fw-bold text-gray-600" id="inOutTableBody">
                                  <tr></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateModalLabel">Update Record</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="updateForm">
                    <input type="hidden" id="recordId" name="recordId">
                    <div class="form-group">
                        <label for="updateDate">NAME:</label>
                        <input type="text" class="form-control" id="updateName" name="updateName">
                    </div>
                    <div class="form-group">
                        <label for="updateDate">DATE:</label>
                        <input type="date" class="form-control" id="updateDate" name="updateDate">
                    </div>
                    <div class="form-group">
                        <label for="updateType">TYPE:</label>
                        <select class="form-control" id="updateType" name="updateType">
                            <option value="In">In</option>
                            <option value="Out">Out</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="updateReason">REASON:</label>
                        <input type="text" class="form-control" id="updateReason" name="updateReason">
                    </div>
                    <div class="form-group">
                        <label for="updateStatus">APPROVAL STATUS:</label>
                        <select class="form-control" id="updateStatus" name="updateStatus">
                            <option value="Accepted">Accepted</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>

                    <button type="submit" class= "button_mian" style="display: block;margin: 0 auto;" onclick="submitForm()">Update</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addModalLabel">Add Request</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="form-group">
                        <label for="addName">NAME:</label>
                        <input type="text" class="form-control" id="addName" name="addName">
                    </div>
                    <div class="form-group">
                        <label for="addDate">DATE:</label>
                        <input type="date" class="form-control" id="addDate" name="addDate">
                    </div>
                    <div class="form-group">
                        <label for="addType">TYPE:</label>
                        <select class="form-control" id="addType" name="addType">
                            <option value="In">In</option>
                            <option value="Out">Out</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="addReason">REASON:</label>
                        <input type="text" class="form-control" id="addReason" name="addReason">
                    </div>
                    <div class="form-group">
                        <label for="addStatus">APPROVAL STATUS:</label>
                        <select class="form-control" id="addStatus" name="addStatus">
                             <option value="Pending">Pending</option>
                            <option value="Accepted">Accepted</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <button type="submit" style="display: block;margin: 0 auto;" class="button_mian">Add</button>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Delete Confirmation Modal for In-Out -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this item?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
            </div>
        </div>
    </div>
</div>

 <div class="modal fade" id="warning-modal" tabindex="-1" aria-labelledby="warning-modal-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="warning-modal-label">Warning</h5>
        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Warning message will be inserted here dynamically -->
      </div>
      <div class="modal-footer">
        <button type="button" class="button_mian" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- Bootstrap Bundle with Popper -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>



{% if request.user.emp_role == "Admin" or request.user.emp_role == "HR" %}
<script>

        // Function to fetch data from API and populate the table

    function fetchDataAndPopulateTable() {
    const token = localStorage.getItem('accessToken');
    fetch('http://127.0.0.1:8000/in-out/',{
     headers: {
                'Authorization': `Bearer ${token}`
            }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }
            return response.json();
        })
        .then(data => {
            const tableBody = document.querySelector('#kt_customers_table tbody');

            // Clear existing table rows
            tableBody.innerHTML = '';

            // Populate table rows with data
            data.forEach((record, index) => {
                const row = document.createElement('tr');
                row.id = `inOutRequestRow${record.id}`; // Set unique ID for each row
                row.innerHTML = `
                    <td>${record.name}</td>
                    <td>${record.date}</td>
                    <td>${record.type}</td>
                    <td>${record.reason}</td>
                    <td>${record.approvel_status}</td>
                    {% if request.user.emp_role == "Admin" or request.user.emp_role == "HR" %}
                    <td class="editbtns">
                        <button class="btn btn-danger text-danger . bg-light" onclick="toggleActionMenu(${record.id})">...</button>
                        <div id="actionMenu_${record.id}" class="action-menu hidden mt-2" style="display: none;">
                            <button class="btn btn-primary text-primary bg-light"  onclick="updateRecord(${record.id})">Update</button>
                            <button class="btn btn-danger text-danger bg-light" onclick="displayDeleteConfirmationModal(${record.id})">Delete</button>
                        </div>
                    </td>
                    {% endif %}
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching records:', error));
}


             // Toggle action menu
            function toggleActionMenu(recordId) {
                const actionMenu = $(`#actionMenu_${recordId}`);
                // Close all other action menus
                $('[id^=actionMenu_]').not(actionMenu).slideUp();
                // Toggle the targeted action menu
                actionMenu.slideToggle();
            }

             function clickOutsideHandler(e) {
                    if (!actionMenu.contains(e.target) && !actionButton.contains(e.target)) {
                         actionMenu.classList.add('hidden');
                            // Remove event listener after closing action menu
                         document.removeEventListener('click', clickOutsideHandler);
                    }
             }
             // Call the function to fetch data and populate the table when the document is ready
             document.addEventListener('DOMContentLoaded', function() {
                    fetchDataAndPopulateTable();
             });

   function deleteRecord(requestId) {
    // Send delete request using AJAX
    $.ajax({
        url: `http://127.0.0.1:8000/in-out/${requestId}/`,
        type: 'DELETE',
        success: function(response) {
            // Remove the corresponding row from the UI
            const row = document.getElementById(`inOutRequestRow${requestId}`);
            if (row) {
                row.remove();
                console.log(`In-out request with ID ${requestId} deleted successfully`);
            } else {
                console.error(`Failed to find in-out request row with ID ${requestId}`);
            }
            location.reload();
        },
        error: function(xhr, status, error) {
            console.error(`Failed to delete in-out request with ID ${requestId}: ${error}`);
            // Optionally, display an error message to the user
            $('#deleteConfirmationModal').find('.modal-body').text(`Failed to delete record: ${error}`);
        }
    });
}

function displayDeleteConfirmationModal(requestId) {
    // Store the request ID in a data attribute of the confirmation modal
    $('#deleteConfirmationModal').data('request-id', requestId);
    // Show the modal
    $('#deleteConfirmationModal').modal('show');
}

// Event listener for delete button click
$('.deleteBtn').on('click', function() {
    // Get the request ID from the delete button's data attribute
    const requestId = $(this).data('request-id');
    displayDeleteConfirmationModal(requestId);
});

// Event listener for confirm delete button click
$('#confirmDeleteBtn').on('click', function() {
    // Get the request ID from the data attribute of the confirmation modal
    const requestId = $('#deleteConfirmationModal').data('request-id');
    // Close the modal
    $('#deleteConfirmationModal').modal('hide');
    // Call the deleteRecord function to perform the deletion
    deleteRecord(requestId);
});



function searchInOut() {
    const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
    const inOutTableBody = document.getElementById('inOutTableBody');

    // If search term is empty, do nothing
    if (!searchTerm) {
        return;
    }

    // Fetch data from API
    fetch('http://127.0.0.1:8000/in-out/')
        .then(response => response.json())
        .then(data => {
            // Clear existing table rows
            inOutTableBody.innerHTML = '';

            // Filter data based on search term and exclude records with "Accepted" status
            const filteredData = data.filter(record =>
                record.name.toLowerCase().startsWith(searchTerm) && record.approvel_status.toLowerCase() !== "accepted");

            // Populate table rows with filtered data
            filteredData.forEach((record, index) => {
                const row = document.createElement('tr');
                row.id = `inOutRequestRow${record.id}`;
                row.innerHTML = `
                    <td>${record.name}</td>
                    <td>${record.date}</td>
                    <td>${record.type}</td>
                    <td>${record.reason}</td>
                    <td>${record.approvel_status}</td>
                    {% if request.user.emp_role == "Admin" or request.user.emp_role == "HR" %}
                    <td class="editbtns">
                        <button class="btn btn-danger text-danger . bg-light" onclick="toggleActionMenu(${record.id})">...</button>
                        <div id="actionMenu_${record.id}" class="action-menu hidden mt-2" style="display:none;">
                            <button class="btn btn-primary text-primary . bg-light"  onclick="updateRecord(${record.id})">Update</button>
                            <button class="btn btn-danger text-danger . bg-light"  onclick="displayDeleteConfirmationModal(${record.id})">Delete</button>
                        </div>
                    </td>
                    {% endif %}
                `;
                inOutTableBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching in-out records:', error));
}

// Prevent default form submission behavior and call searchInOut() function
document.querySelector('.search-form').addEventListener('submit', function(event) {
    event.preventDefault();
    searchInOut();
});


     function updateRecord(recordId) {
        console.log('Update button clicked for record ID:', recordId);
        // Fetch the record data
        fetch(`http://127.0.0.1:8000/in-out/${recordId}/`)
            .then(response => response.json())
            .then(data => {
                // Populate the form fields with record data
                document.getElementById('recordId').value = data.id;
                document.getElementById('updateName').value = data.name;
                document.getElementById('updateDate').value = data.date;
                document.getElementById('updateType').value = data.type;
                document.getElementById('updateReason').value = data.reason;
                document.getElementById('updateStatus').value = data.approvel_status;

                // Show the update modal
                $('#updateModal').modal('show');
            })
            .catch(error => console.error('Error fetching record:', error));
    }

    // Function to submit the update form data via AJAX
    function submitForm() {
        event.preventDefault();
        const recordId = $('#recordId').val();
        const updatedName = $('#updateName').val();
        const updatedDate = $('#updateDate').val();
        const updatedType = $('#updateType').val();
        const updatedReason = $('#updateReason').val();
        const updatedStatus = $('#updateStatus').val();

        fetch(`http://127.0.0.1:8000/in-out/${recordId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: updatedName,
                date: updatedDate,
                type: updatedType,
                reason: updatedReason,
                approvel_status: updatedStatus // Corrected spelling here
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update record');
                }
                console.log('Record updated successfully');
                location.reload();
                // Close the update modal
                $('#updateModal').modal('hide');
                // Refresh record data in the table
                fetchDataAndPopulateTable(); // You need to define this function to fetch and populate records
            })
            .catch(error => console.error('Error updating record:', error));
    }


    document.getElementById('addRequestButton').addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default behavior of the button, like form submission or page navigation

    // Show the add record popup/modal
    $('#addModal').modal('show');
});
    // Function to add a new record
function addRecord() {
    // Get form data
    const name = $('#addName').val().trim();
    const date = $('#addDate').val();
    const type = $('#addType').val();
    const reason = $('#addReason').val();
    const status = $('#addStatus').val();


    // Create new record object
    console.log("--------------",name)
    const newRecord = {
        name: name,
        date: date,
        type: type,
        reason: reason,
        approvel_status: status
    };

    // Send POST request to API endpoint
    console.log("-----------", typeof newRecord)
    const token = localStorage.getItem('accessToken');
    $.ajax({
        url: 'http://127.0.0.1:8000/in-out/',
        type: 'POST',
         headers: {
                'Authorization': `Bearer ${token}`,
            },
        contentType: 'application/json',
        data: JSON.stringify(newRecord),
        success: function(response) {
            // Record added successfully
            console.log('Record added successfully.');
            window.location.href = "http://127.0.0.1:8000/inout/";
            // Close the modal
            $('#addModal').modal('hide');
            // Optionally, you can refresh the data table or perform any other actions
        },
        error: function(xhr, status, error) {
            // Error adding record
            console.error('Failed to add record:', error);
            // Optionally, you can display an error message to the user
        }
    });
}

// Event listener for form submission
$('#addForm').submit(function(event) {
    event.preventDefault(); // Prevent default form submission
    addRecord(); // Call addRecord function to add the record
});
</script>
{% else %}
<script>

        // Function to fetch data from API and populate the table

    function fetchDataAndPopulateTable() {
    const token = localStorage.getItem('accessToken');
    fetch('http://127.0.0.1:8000/inoutuser/',{
     headers: {
                'Authorization': `Bearer ${token}`
            }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }
            return response.json();
        })
        .then(data => {
            const tableBody = document.querySelector('#kt_customers_table tbody');

            // Clear existing table rows
            tableBody.innerHTML = '';

            // Populate table rows with data
            data.forEach((record, index) => {
                const row = document.createElement('tr');
                row.id = `inOutRequestRow${record.id}`; // Set unique ID for each row
                row.innerHTML = `
                    <td>${record.name}</td>
                    <td>${record.date}</td>
                    <td>${record.type}</td>
                    <td>${record.reason}</td>
                    <td>${record.approvel_status}</td>
                    {% if request.user.emp_role == "Admin" or request.user.emp_role == "HR" %}
                    <td class="editbtns">
                        <button class="btn btn-danger text-danger . bg-light" onclick="toggleActionMenu(${record.id})">...</button>
                        <div id="actionMenu_${record.id}" class="action-menu hidden mt-2" style="display: none;">
                            <button class="btn btn-primary text-primary bg-light"  onclick="updateRecord(${record.id})">Update</button>
                            <button class="btn btn-danger text-danger bg-light" onclick="displayDeleteConfirmationModal(${record.id})">Delete</button>
                        </div>
                    </td>
                    {% endif %}
                `;
                tableBody.appendChild(row);
            });
        })
        .catch(error => console.error('Error fetching records:', error));
}


             // Toggle action menu
            function toggleActionMenu(recordId) {
                const actionMenu = $(`#actionMenu_${recordId}`);
                // Close all other action menus
                $('[id^=actionMenu_]').not(actionMenu).slideUp();
                // Toggle the targeted action menu
                actionMenu.slideToggle();
            }

             function clickOutsideHandler(e) {
                    if (!actionMenu.contains(e.target) && !actionButton.contains(e.target)) {
                         actionMenu.classList.add('hidden');
                            // Remove event listener after closing action menu
                         document.removeEventListener('click', clickOutsideHandler);
                    }
             }
             // Call the function to fetch data and populate the table when the document is ready
             document.addEventListener('DOMContentLoaded', function() {
                    fetchDataAndPopulateTable();
             });

     function deleteRecord(requestId) {
    // Send delete request using AJAX
    $.ajax({
        url: `http://127.0.0.1:8000/in-out/${requestId}/`,
        type: 'DELETE',
        success: function(response) {
            // Remove the corresponding row from the UI
            const row = document.getElementById(`inOutRequestRow${requestId}`);
            if (row) {
                row.remove();
                console.log(`In-out request with ID ${requestId} deleted successfully`);
            } else {
                console.error(`Failed to find in-out request row with ID ${requestId}`);
            }
            location.reload();
        },
        error: function(xhr, status, error) {
            console.error(`Failed to delete in-out request with ID ${requestId}: ${error}`);
        }
    });
}

function displayDeleteConfirmationModal(requestId) {
        // Store the request ID in a data attribute of the confirmation modal
        $('#deleteConfirmationModal').data('request-id', requestId);
        // Show the modal
        $('#deleteConfirmationModal').modal('show');
    }

    // Event listener for delete button click
    $('.deleteBtn').on('click', function() {
        // Get the request ID from the delete button's data attribute
        const requestId = $(this).data('request-id');
        displayDeleteConfirmationModal(requestId);
    });

    // Event listener for confirm delete button click
    $('#confirmDeleteBtn').on('click', function() {
        // Get the request ID from the data attribute of the confirmation modal
        const requestId = $('#deleteConfirmationModal').data('request-id');
        // Call the deleteRecord function to perform the deletion
        deleteRecord(requestId);
        // Close the modal
        $('#deleteConfirmationModal').modal('hide');
    });


function searchInOut() {
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        const inOutTableBody = document.getElementById('inOutTableBody');

        if(!searchTerm){
         return;
        }
        // Fetch data from API
        fetch('http://127.0.0.1:8000/in-out/')
            .then(response => response.json())
            .then(data => {
                // Clear existing table rows
                inOutTableBody.innerHTML = '';

                // Filter data based on search term
                const filteredData = data.filter(record => record.name.toLowerCase().includes(searchTerm));

                // Populate table rows with filtered data
                filteredData.forEach((record, index) => {
                    const row = document.createElement('tr');
                    row.id = `inOutRequestRow${record.id}`;
                    row.innerHTML = `
                        <td>${record.name}</td>
                        <td>${record.date}</td>
                        <td>${record.type}</td>
                        <td>${record.reason}</td>
                        <td>${record.approvel_status}</td>
                        {% if request.user.emp_role == "Admin" or request.user.emp_role == "HR" %}
                        <td class="editbtns">
                            <button class="btn btn-danger text-danger . bg-light" onclick="toggleActionMenu(${record.id})">...</button>
                            <div id="actionMenu_${record.id}" class="action-menu hidden mt-2">
                                <button class="btn btn-primary text-primary . bg-light"  onclick="updateRecord(${record.id})">Update</button>
                                <button class="btn btn-danger text-danger . bg-light"  onclick="displayDeleteConfirmationModal(${record.id})">Delete</button>
                            </div>
                        </td>
                        {% endif %}
                    `;
                    inOutTableBody.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching in-out records:', error));
    }

    // Prevent default form submission behavior and call searchInOut() function
    document.querySelector('.search-form').addEventListener('submit', function(event) {
        event.preventDefault();
        searchInOut();
    });


     function updateRecord(recordId) {
        console.log('Update button clicked for record ID:', recordId);
        // Fetch the record data
        fetch(`http://127.0.0.1:8000/in-out/${recordId}/`)
            .then(response => response.json())
            .then(data => {
                // Populate the form fields with record data
                document.getElementById('recordId').value = data.id;
                document.getElementById('updateName').value = data.name;
                document.getElementById('updateDate').value = data.date;
                document.getElementById('updateType').value = data.type;
                document.getElementById('updateReason').value = data.reason;
                document.getElementById('updateStatus').value = data.approvel_status;

                // Show the update modal
                $('#updateModal').modal('show');
            })
            .catch(error => console.error('Error fetching record:', error));
    }

    // Function to submit the update form data via AJAX
    function submitForm() {
        event.preventDefault();
        const recordId = $('#recordId').val();
        const updatedName = $('#updateName').val();
        const updatedDate = $('#updateDate').val();
        const updatedType = $('#updateType').val();
        const updatedReason = $('#updateReason').val();
        const updatedStatus = $('#updateStatus').val();

        fetch(`http://127.0.0.1:8000/in-out/${recordId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: updatedName,
                date: updatedDate,
                type: updatedType,
                reason: updatedReason,
                approvel_status: updatedStatus // Corrected spelling here
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update record');
                }
                console.log('Record updated successfully');
                // Close the update modal
                $('#updateModal').modal('hide');
                // Refresh record data in the table
                fetchDataAndPopulateTable(); // You need to define this function to fetch and populate records
            })
            .catch(error => console.error('Error updating record:', error));
    }


    document.getElementById('addRequestButton').addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default behavior of the button, like form submission or page navigation

    // Show the add record popup/modal
    $('#addModal').modal('show');
});
    // Function to add a new record
function addRecord() {
    // Get form data
    const name = $('#addName').val().trim();
    const date = $('#addDate').val();
    const type = $('#addType').val();
    const reason = $('#addReason').val();
    const status = $('#addStatus').val();



    // Create new record object
    const token = localStorage.getItem('accessToken');
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    let data1 = JSON.parse(jsonPayload)
    const newRecord = {
        employee :data1.user_id,
        name: name,
        date: date,
        type: type,
        reason: reason,
        approvel_status: status
    };
    console.log("------------", newRecord)
    // Send POST request to API endpoint


    $.ajax({
        url: 'http://127.0.0.1:8000/in-out/',
        data: JSON.stringify(newRecord),
        type: 'POST',
         headers: {
                'Authorization': `Bearer ${token}`,
            },
        success: function(response) {
            // Record added successfully
            console.log('Record added successfully.');
            window.location.href = "http://127.0.0.1:8000/inout/";
            // Close the modal
            $('#addModal').modal('hide');
            // Optionally, you can refresh the data table or perform any other actions
        },
        error: function(xhr, status, error) {
            // Error adding record
            console.error('Failed to add record:', error);
            // Optionally, you can display an error message to the user
        }
    });
}

// Event listener for form submission
$('#addForm').submit(function(event) {
    event.preventDefault(); // Prevent default form submission
    addRecord(); // Call addRecord function to add the record
});
</script>
{% endif %}


<script>



    document.addEventListener('DOMContentLoaded', function () {
    // Function to display employee in-out data in the table
    function displayEmployeeInOutData(data) {
        var tableBody = document.getElementById('inOutTableBody');
        tableBody.innerHTML = ''; // Clear existing table rows

        // Check if data is empty
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6">There are no records found.</td></tr>';
            return;
        }

        data.forEach(function (record) {
            if (record.approval_status !== 'Accepted') { // Check if the status is not "Accepted"
                var row = `
                    <tr>
                        <td>${record.name}</td>
                        <td>${record.date}</td>
                        <td>${record.type}</td>
                        <td>${record.reason}</td>
                        <td>${record.approvel_status}</td>
                        {% if request.user.emp_role == "Admin" or request.user.emp_role == "HR" %}
                        <td class="editbtns">
                        <button class="btn btn-danger text-danger . bg-light" onclick="toggleActionMenu(${record.id})">...</button>
                        <div id="actionMenu_${record.id}" class="action-menu hidden mt-2" style="display: none;">
                            <button class="btn btn-primary text-primary bg-light"  onclick="updateRecord(${record.id})">Update</button>
                            <button class="btn btn-danger text-danger bg-light" onclick="displayDeleteConfirmationModal(${record.id})">Delete</button>
                        </div>
                        </td>
                        {% endif %}
                    </tr>
                `;
                tableBody.innerHTML += row;
            }
        });
    }

     // Toggle action menu
     function toggleActionMenu(recordId) {
                const actionMenu = $(`#actionMenu_${recordId}`);
                // Close all other action menus
                $('[id^=actionMenu_]').not(actionMenu).slideUp();
                // Toggle the targeted action menu
                actionMenu.slideToggle();
     }

     function clickOutsideHandler(e) {
                    if (!actionMenu.contains(e.target) && !actionButton.contains(e.target)) {
                         actionMenu.classList.add('hidden');
                            // Remove event listener after closing action menu
                         document.removeEventListener('click', clickOutsideHandler);
                    }
     }

    // Function to filter in-out records based on selected month and status
    function filterEmployeeInOutRecords(data, month, status) {
        // Filter data based on selected month and status
        var filteredData = data.filter(function (record) {
            return (!month || record.date.substring(0, 7) === month) && (!status || record.approvel_status === status);
        });

        // Display filtered data
        displayEmployeeInOutData(filteredData);
    }

    // Event listener for search button click (for month and status)
    document.getElementById('searchButton1').addEventListener('click', function () {
        var month = document.getElementById('month').value;
        var status = document.getElementById('statustypesearch').value;
         if(!month && !status) {
         return;
        }
        // Fetch all employee in-out records
        fetch('http://127.0.0.1:8000/in-out/')
            .then(response => response.json())
            .then(data => {
                // Filter and display records based on selected month and status
                filterEmployeeInOutRecords(data, month, status);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    });

    // Initial loading: Fetch all employee in-out records and display only "Pending" and "Rejected" status
    fetch('http://127.0.0.1:8000/in-out/')
        .then(response => response.json())
        .then(data => {
            // Filter data to display only "Pending" and "Rejected" status initially
            var initialStatus = ['Pending', 'Rejected'];
            var filteredData = data.filter(record => initialStatus.includes(record.approvel_status));

            // Display filtered data
            displayEmployeeInOutData(filteredData);
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
});

</script>


{% endblock main-content %}